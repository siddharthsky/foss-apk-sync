name: Fetch Latest APK URLs

on:
  schedule:
    - cron: "0 3 * * 0"   # Weekly (Sunday)
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-readme:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup tools
        run: sudo apt-get update && sudo apt-get install -y jq curl

      - name: Create version directory
        run: mkdir -p version

      # =========================
      # Fetch latest info
      # =========================
      - name: Fetch release data
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail

          METRO_API="https://api.github.com/repos/mostafaalagamy/Metrolist/releases/latest"
          CROM_API="https://api.github.com/repos/uazo/cromite/releases/latest"
          MIX_API="https://api.github.com/repos/driftywinds/mixplorer-releases/releases/latest"
          STUBE_API="https://api.github.com/repos/yuliskov/SmartTube/releases/latest"

          auth_header="Authorization: Bearer $GH_TOKEN"

          METRO_JSON=$(curl -sH "$auth_header" "$METRO_API")
          CROM_JSON=$(curl -sH "$auth_header" "$CROM_API")
          MIX_JSON=$(curl -sH "$auth_header" "$MIX_API")
          STUBE_JSON=$(curl -sH "$auth_header" "$STUBE_API")

          METRO_VERSION=$(jq -r '.tag_name' <<< "$METRO_JSON")
          METRO_URL=$(jq -r '.assets[] | select(.name=="app-arm64-with-Google-Cast.apk") | .browser_download_url' <<< "$METRO_JSON")

          CROM_VERSION=$(jq -r '.tag_name' <<< "$CROM_JSON")
          CROM_VERSION_SH="${CROM_VERSION:0:20}"
          CROM_URL=$(jq -r '.assets[] | select(.name=="arm64_ChromePublic.apk") | .browser_download_url' <<< "$CROM_JSON")

          MIX_VERSION=$(jq -r '.tag_name' <<< "$MIX_JSON")
          MIX_URL=$(jq -r '.assets[] | select(.name | test("MiXplorer.*\\.apk")) | .browser_download_url' <<< "$MIX_JSON")

          STUBE_VERSION=$(jq -r '.tag_name' <<< "$STUBE_JSON")
          STUBE_URL=$(jq -r '.assets[] | select(.name | test("SmartTube_stable_*\\_arm64-v8a.apk")) | .browser_download_url' <<< "$STUBE_JSON")


          if [[ -z "$METRO_URL" || -z "$CROM_URL" || -z "$MIX_URL" ]]; then
            echo "âŒ One or more APK URLs not found"
            exit 1
          fi

          echo "$METRO_VERSION" > version/metrolist.version
          echo "$CROM_VERSION" > version/cromite.version
          echo "$MIX_VERSION" > version/mixplorer.version
          echo "$STUBE_VERSION" > version/stube.version

          DATE=$(date -u +"%Y-%m-%d")

          cat > README.md <<EOF
          # ðŸ“¦ FOSS APK Sync

          Auto-updated weekly via GitHub Actions.

          | App | Version | Download | Last Updated |
          |-----|--------|----------|--------------|
          | **YT Revanced** | latest | [Download APK](https://github.com/FiorenMas/Revanced-And-Revanced-Extended-Non-Root/releases/download/all/youtube-revanced.apk) | latest |
          | **Metrolist** | $METRO_VERSION | [Download APK]($METRO_URL) | $DATE |
          | **Cromite** | $CROM_VERSION_SH | [Download APK]($CROM_URL) | $DATE |
          | **MiXplorer** | $MIX_VERSION | [Download APK]($MIX_URL) | $DATE |
          | **STube** | $STUBE_VERSION | [Download APK]($STUBE_URL) | $DATE |

          ---
          **Source Repos**
          - https://github.com/FiorenMas
          - https://github.com/mostafaalagamy/Metrolist
          - https://github.com/uazo/cromite
          - https://github.com/driftywinds/mixplorer-releases
          - https://github.com/yuliskov/SmartTube
          EOF

      # =========================
      # Commit if changed
      # =========================
      - name: Commit and push changes
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          if git status --porcelain | grep -E "README.md|version/"; then
            git add README.md version
            git commit -m "chore: update latest APK URLs"
            git push
          else
            echo "No updates to commit"
          fi
