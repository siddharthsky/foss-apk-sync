name: Fetch Latest APK URLs

on:
  schedule:
    - cron: "0 3 * * 0"   # Weekly (Sunday)
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-readme:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup tools
        run: sudo apt-get install -y jq curl

      - name: Create version directory
        run: mkdir -p version

      # =========================
      # Fetch latest info
      # =========================
      - name: Fetch release data
        run: |
          set -e

          METRO_API="https://api.github.com/repos/mostafaalagamy/Metrolist/releases/latest"
          CROM_API="https://api.github.com/repos/uazo/cromite/releases/latest"

          METRO_VERSION=$(curl -s $METRO_API | jq -r '.tag_name')
          METRO_URL=$(curl -s $METRO_API | jq -r '.assets[] | select(.name=="app-arm64-with-Google-Cast.apk") | .browser_download_url')

          CROM_VERSION=$(curl -s $CROM_API | jq -r '.tag_name')
          CROM_VERSION_SH="${CROM_VERSION:0:20}"
          CROM_URL=$(curl -s $CROM_API | jq -r '.assets[] | select(.name=="arm64_ChromePublic.apk") | .browser_download_url')

          if [ -z "$METRO_URL" ] || [ -z "$CROM_URL" ]; then
            echo "APK URL not found"
            exit 1
          fi

          echo "$METRO_VERSION" > version/metrolist.version
          echo "$CROM_VERSION" > version/cromite.version

          DATE=$(date -u +"%Y-%m-%d")

          cat > README.md <<EOF
          # ðŸ“¦ FOSS APK Sync

          Auto-updated weekly via GitHub Actions.

          | App | Version | Download | Last Updated |
          |-----|--------|----------|--------------|
          | **YT Revanced** | latest | [Download APK](https://github.com/FiorenMas/Revanced-And-Revanced-Extended-Non-Root/releases/download/all/youtube-revanced.apk) | latest |
          | **Metrolist** | $METRO_VERSION | [Download APK]($METRO_URL) | $DATE |
          | **Cromite** | $CROM_VERSION_SH | [Download APK]($CROM_URL) | $DATE |

          ---
          **Source Repos**
          - https://github.com/mostafaalagamy/Metrolist
          - https://github.com/uazo/cromite
          EOF

      # =========================
      # Commit if changed
      # =========================
      - name: Commit and push changes
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          if git status --porcelain | grep -E "README.md|version/"; then
            git add README.md version
            git commit -m "chore: update latest APK URLs"
            git push
          else
            echo "No updates to commit"
          fi
