name: Fetch Latest APK URLs

on:
  schedule:
    - cron: "0 3 * * 0"   # Weekly (Sunday)
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-readme:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install tools
        run: sudo apt-get update && sudo apt-get install -y jq curl

      - name: Prepare folders
        run: mkdir -p version

      - name: Fetch apps from apps.json
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail

          DATE=$(date -u +"%Y-%m-%d")
          AUTH="Authorization: Bearer $GH_TOKEN"

          {
            echo "# üì¶ FOSS APK Sync"
            echo ""
            echo "Auto-updated weekly via GitHub Actions."
            echo ""
            echo "| App | Version | Download | Last Updated |"
            echo "|-----|--------|----------|--------------|"
          } > README.md

          jq -c '.[]' apps.json | while read -r app; do
            NAME=$(jq -r '.name' <<< "$app")
            TYPE=$(jq -r '.type' <<< "$app")

            echo "‚û°Ô∏è Processing $NAME"

            if [[ "$TYPE" == "static" ]]; then
              VERSION=$(jq -r '.version' <<< "$app")
              URL=$(jq -r '.url' <<< "$app")

            else
              REPO=$(jq -r '.repo' <<< "$app")
              VERSION_FILE=$(jq -r '.version_file' <<< "$app")
              TAG=$(jq -r '.tag // empty' <<< "$app")

              if [[ -n "$TAG" ]]; then
                API="https://api.github.com/repos/$REPO/releases/tags/$TAG"
              else
                API="https://api.github.com/repos/$REPO/releases/latest"
              fi

              JSON=$(curl -sfH "$AUTH" "$API" || echo '{}')

              # fallback to latest if tag failed
              if jq -e '.message?' <<< "$JSON" >/dev/null; then
                echo "‚ö†Ô∏è Tag not found for $NAME ‚Äî falling back to latest"
                JSON=$(curl -sfH "$AUTH" "https://api.github.com/repos/$REPO/releases/latest" || echo '{}')
              fi

              VERSION=$(jq -r '.tag_name // empty' <<< "$JSON")

              [[ -z "$VERSION" ]] && VERSION="unknown"

              if jq -e '.version_trim?' <<< "$app" >/dev/null; then
                TRIM=$(jq -r '.version_trim' <<< "$app")
                VERSION="${VERSION:0:$TRIM}"
              fi

              ASSETS=$(jq '.assets // []' <<< "$JSON")

              if jq -e '.asset_name?' <<< "$app" >/dev/null; then
                ASSET=$(jq -r '.asset_name' <<< "$app")
                URL=$(jq -r --arg a "$ASSET" '
                  .[]
                  | select(.name==$a)
                  | .browser_download_url
                ' <<< "$ASSETS")
              else
                REGEX=$(jq -r '.asset_regex' <<< "$app")
                URL=$(jq -r --arg re "$REGEX" '
                  .[]
                  | select(.name | test($re))
                  | .browser_download_url
                ' <<< "$ASSETS")
              fi

              echo "$VERSION" > "version/$VERSION_FILE"
            fi

            if [[ -z "${URL:-}" ]]; then
              echo "‚ùå APK not found for $NAME ‚Äî skipping"
              continue
            fi

            echo "| **$NAME** | $VERSION | [Download APK]($URL) | $DATE |" >> README.md
          done

      - name: Commit and push if changed
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          if git status --porcelain | grep -E "README.md|version/"; then
            git add README.md version apps.json
            git commit -m "chore: update APK versions"
            git push
          else
            echo "No changes to commit"
          fi
