- name: Fetch apps from config
  env:
    GH_TOKEN: ${{ github.token }}
  run: |
    set -euo pipefail
    mkdir -p version

    DATE=$(date -u +"%Y-%m-%d")
    auth="Authorization: Bearer $GH_TOKEN"

    echo "# ðŸ“¦ FOSS APK Sync" > README.md
    echo "" >> README.md
    echo "Auto-updated weekly via GitHub Actions." >> README.md
    echo "" >> README.md
    echo "| App | Version | Download | Last Updated |" >> README.md
    echo "|-----|--------|----------|--------------|" >> README.md

    jq -c '.[]' apps.json | while read -r app; do
      NAME=$(jq -r '.name' <<< "$app")
      TYPE=$(jq -r '.type' <<< "$app")

      if [[ "$TYPE" == "static" ]]; then
        VERSION=$(jq -r '.version' <<< "$app")
        URL=$(jq -r '.url' <<< "$app")

      else
        REPO=$(jq -r '.repo' <<< "$app")
        VERSION_FILE=$(jq -r '.version_file' <<< "$app")
        API="https://api.github.com/repos/$REPO/releases/latest"

        JSON=$(curl -sH "$auth" "$API")
        VERSION=$(jq -r '.tag_name' <<< "$JSON")

        if jq -e '.version_trim' <<< "$app" >/dev/null; then
          TRIM=$(jq -r '.version_trim' <<< "$app")
          VERSION="${VERSION:0:$TRIM}"
        fi

        if jq -e '.asset_name' <<< "$app" >/dev/null; then
          URL=$(jq -r '.assets[] | select(.name=="'"$(jq -r '.asset_name' <<< "$app")"'") | .browser_download_url' <<< "$JSON")
        else
          REGEX=$(jq -r '.asset_regex' <<< "$app")
          URL=$(jq -r '.assets[] | select(.name | test("'"$REGEX"'")) | .browser_download_url' <<< "$JSON")
        fi

        echo "$VERSION" > "version/$VERSION_FILE"
      fi

      echo "| **$NAME** | $VERSION | [Download APK]($URL) | $DATE |" >> README.md
    done
