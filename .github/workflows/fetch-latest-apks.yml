name: Fetch Latest APK URLs

on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-readme:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install tools
        run: sudo apt-get update && sudo apt-get install -y jq curl

      - name: Prepare folders
        run: |
          mkdir -p version
          cp README.md README.old.md 2>/dev/null || true

      - name: Fetch apps from apps.json
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail

          DATE=$(date -u +"%Y-%m-%d")
          AUTH="Authorization: Bearer $GH_TOKEN"
          SOURCES=()

          {
            echo "# ðŸ“¦ FOSS APK Sync"
            echo ""
            echo "Auto-updated weekly via GitHub Actions."
            echo ""
            echo "| App | Version | Download | Last Updated |"
            echo "|-----|--------|----------|--------------|"
          } > README.md

          while read -r app; do
            NAME=$(jq -r '.name' <<< "$app")
            TYPE=$(jq -r '.type' <<< "$app")

            echo "âž¡ï¸ Processing $NAME"

            URL=""
            VERSION=""

            if [[ "$TYPE" == "static" ]]; then
              VERSION=$(jq -r '.version' <<< "$app")
              URL=$(jq -r '.url' <<< "$app")
              SOURCES+=("$URL")

            else
              REPO=$(jq -r '.repo' <<< "$app")
              VERSION_FILE=$(jq -r '.version_file' <<< "$app")
              TAG=$(jq -r '.tag // empty' <<< "$app")

              SOURCES+=("https://github.com/$REPO")

              if [[ -n "$TAG" ]]; then
                API="https://api.github.com/repos/$REPO/releases/tags/$TAG"
              else
                API="https://api.github.com/repos/$REPO/releases/latest"
              fi

              JSON=$(curl -sfH "$AUTH" "$API" || echo '{}')

              if jq -e '.message?' <<< "$JSON" >/dev/null; then
                JSON=$(curl -sfH "$AUTH" "https://api.github.com/repos/$REPO/releases/latest" || echo '{}')
              fi

              VERSION=$(jq -r '.tag_name // "unknown"' <<< "$JSON")

              if jq -e '.version_trim?' <<< "$app" >/dev/null; then
                TRIM=$(jq -r '.version_trim' <<< "$app")
                VERSION="${VERSION:0:$TRIM}"
              fi

              ASSETS=$(jq '.assets // []' <<< "$JSON")

              if jq -e '.asset_name?' <<< "$app" >/dev/null; then
                ASSET=$(jq -r '.asset_name' <<< "$app")
                URL=$(jq -r --arg a "$ASSET" '
                  .[] | select(.name==$a) | .browser_download_url
                ' <<< "$ASSETS")
              else
                REGEX=$(jq -r '.asset_regex' <<< "$app")
                URL=$(jq -r --arg re "$REGEX" '
                  .[] | select(.name | test($re)) | .browser_download_url
                ' <<< "$ASSETS")
              fi

              echo "$VERSION" > "version/$VERSION_FILE"
            fi

            if [[ -z "$URL" ]]; then
              echo "âŒ APK not found for $NAME â€” skipping"
              continue
            fi

            # Get previous URL and date from old README
            OLD_LINE=$(grep -F "| **$NAME** |" README.old.md 2>/dev/null || true)
            OLD_URL=$(echo "$OLD_LINE" | sed -n 's/.*(\(http[^)]*\)).*/\1/p')
            OLD_DATE=$(echo "$OLD_LINE" | awk -F'|' '{print $5}' | xargs)

            # Decide date
            if [[ "$URL" == "$OLD_URL" && -n "${OLD_DATE:-}" ]]; then
              FINAL_DATE="$OLD_DATE"
            else
              FINAL_DATE="$DATE"
            fi

            echo "| **$NAME** | $VERSION | [Download APK]($URL) | $FINAL_DATE |" >> README.md

          done < <(jq -c '.[]' apps.json)

          # -------- SOURCES --------

          echo "" >> README.md
          echo "## ðŸ”— Sources" >> README.md

          printf "%s\n" "${SOURCES[@]}" \
            | sort -u \
            | while read -r src; do
                echo "- $src" >> README.md
              done

      - name: Commit and push if changed
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          if git status --porcelain | grep -E "README.md|version/"; then
            git add README.md version apps.json
            git commit -m "chore: update APK versions"
            git push
          else
            echo "No changes to commit"
          fi
