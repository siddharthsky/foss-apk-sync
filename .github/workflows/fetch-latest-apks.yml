name: Fetch Latest APK URLs

on:
  schedule:
    - cron: "0 3 * * 0"   # Weekly (Sunday)
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-readme:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup tools
        run: sudo apt-get update && sudo apt-get install -y jq curl

      - name: Create version directory
        run: mkdir -p version

      # =========================
      # Fetch latest APK info
      # =========================
      - name: Fetch release data
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail

          auth_header="Authorization: Bearer $GH_TOKEN"
          DATE=$(date -u +"%Y-%m-%d")
          ROWS=""

          # ==================================================
          # APP CONFIG (add new apps here â€“ ONE LINE EACH)
          # Name | owner/repo | asset-regex | version-file | shorten-version
          # ==================================================
          APPS=(
            "Metrolist|mostafaalagamy/Metrolist|app-arm64-with-Google-Cast.apk|metrolist.version|false"
            "Cromite|uazo/cromite|arm64_ChromePublic.apk|cromite.version|true"
            "MiXplorer|driftywinds/mixplorer-releases|MiXplorer.*\\.apk|mixplorer.version|false"
            "STube|yuliskov/SmartTube|SmartTube_stable_.*_arm64-v8a.apk|stube.version|false"
          )

          for APP in "${APPS[@]}"; do
            IFS="|" read -r NAME REPO ASSET VERSION_FILE SHORTEN <<< "$APP"

            API="https://api.github.com/repos/$REPO/releases/latest"
            JSON=$(curl -sH "$auth_header" "$API")

            VERSION=$(jq -r '.tag_name' <<< "$JSON")
            URL=$(jq -r ".assets[] | select(.name | test(\"$ASSET\")) | .browser_download_url" <<< "$JSON")

            if [[ -z "$URL" ]]; then
              echo "âŒ APK not found for $NAME"
              exit 1
            fi

            [[ "$SHORTEN" == "true" ]] && VERSION="${VERSION:0:20}"

            echo "$VERSION" > "version/$VERSION_FILE"

            ROWS+="| **$NAME** | $VERSION | [Download APK]($URL) | $DATE |\n"
          done

          # =========================
          # Generate README
          # =========================
          cat > README.md <<EOF
          # ðŸ“¦ FOSS APK Sync

          Auto-updated weekly via GitHub Actions.

          | App | Version | Download | Last Updated |
          |-----|--------|----------|--------------|
          | **YT Revanced** | latest | [Download APK](https://github.com/FiorenMas/Revanced-And-Revanced-Extended-Non-Root/releases/download/all/youtube-revanced.apk) | latest |
          $ROWS
          ---
          **Source Repos**
          - https://github.com/FiorenMas
          - https://github.com/mostafaalagamy/Metrolist
          - https://github.com/uazo/cromite
          - https://github.com/driftywinds/mixplorer-releases
          - https://github.com/yuliskov/SmartTube
          EOF

      # =========================
      # Commit if changed
      # =========================
      - name: Commit and push changes
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          if git status --porcelain | grep -E "README.md|version/"; then
            git add README.md version
            git commit -m "chore: update latest APK URLs"
            git push
          else
            echo "No updates to commit"
          fi
